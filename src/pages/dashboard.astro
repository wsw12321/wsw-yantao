---
// src/pages/dashboard.astro
import Layout from '../layouts/login_Layout.astro';
import { validateSession } from '../lib/session';
import { getSessionIdFromCookie } from '../lib/cookies';

// æœåŠ¡ç«¯æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
const cookieHeader = Astro.request.headers.get('cookie');
const sessionId = getSessionIdFromCookie(cookieHeader);

let user = null;

if (sessionId) {
  const db = Astro.locals.runtime.env.DB;
  const session = await validateSession(db, sessionId);
  if (session) {
    user = {
      id: session.user_id,
      username: session.username,
      email: session.email,
    };
  }
}

// æœªç™»å½•åˆ™é‡å®šå‘åˆ°ç™»å½•é¡µ
if (!user) {
  return Astro.redirect('/login');
}
---

<Layout title="æ§åˆ¶å°">
  <div class="dashboard">
    <div class="welcome-card">
      <div class="avatar">
        {(user.username as string).charAt(0).toUpperCase()}
      </div>
      <h1>æ¬¢è¿å›æ¥, {user.username}! ğŸ‰</h1>
      <p>ä½ å·²æˆåŠŸç™»å½•</p>
    </div>
    
    <div class="info-cards">
      <div class="info-card">
        <h3>ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</h3>
        <div class="info-item">
          <span class="info-label">ç”¨æˆ·ID:</span>
          <span>{user.id}</span>
        </div>
        <div class="info-item">
          <span class="info-label">ç”¨æˆ·å:</span>
          <span>{user.username}</span>
        </div>
        <div class="info-item">
          <span class="info-label">é‚®ç®±:</span>
          <span>{user.email}</span>
        </div>
      </div>
      
      <div class="info-card">
        <h3>ğŸ” è´¦å·å®‰å…¨</h3>
        <p>ä½ çš„å¯†ç å·²åŠ å¯†å­˜å‚¨ï¼Œå³ä½¿æ•°æ®åº“æ³„éœ²ä¹Ÿä¸ä¼šæš´éœ²ä½ çš„æ˜æ–‡å¯†ç ã€‚</p>
        <p>ä½ çš„ç™»å½•ä¼šè¯å°†åœ¨ 7 å¤©åè‡ªåŠ¨è¿‡æœŸã€‚</p>
      </div>
    </div>
    
    <button id="logout-btn" class="btn-logout">é€€å‡ºç™»å½•</button>
  </div>
</Layout>

<style>
  .dashboard {
    width: 100%;
    max-width: 700px;
    color: white;
  }
  
  .welcome-card {
    text-align: center;
    margin-bottom: 2rem;
  }
  
  .avatar {
    width: 80px;
    height: 80px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    margin: 0 auto 1rem;
    backdrop-filter: blur(10px);
  }
  
  h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }
  
  .info-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  @media (max-width: 600px) {
    .info-cards {
      grid-template-columns: 1fr;
    }
  }
  
  .info-card {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 1.5rem;
  }
  
  .info-card h3 {
    margin-bottom: 1rem;
    font-size: 1.2rem;
  }
  
  .info-card p {
    opacity: 0.9;
    line-height: 1.6;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  
  .info-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .info-label {
    opacity: 0.7;
  }
  
  .btn-logout {
    display: block;
    width: 100%;
    max-width: 200px;
    margin: 0 auto;
    padding: 0.75rem 2rem;
    background: rgba(255,255,255,0.15);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s;
  }
  
  .btn-logout:hover {
    background: rgba(255,255,255,0.25);
  }
</style>

<script>
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    const res = await fetch('/api/logout', { method: 'POST' });
    if (res.ok) {
      window.location.href = '/';
    }
  });
</script>