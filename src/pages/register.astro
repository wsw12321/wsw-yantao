---
// src/pages/register.astro
import Layout from '../layouts/login_Layout.astro';
---

<Layout title="注册">
  <div class="form-container">
    <h2>创建新账号</h2>
    
    <div id="message" class="message" style="display: none;"></div>
    
    <form id="register-form">
      <div class="form-group">
        <label for="username">用户名</label>
        <input 
          type="text" 
          id="username" 
          name="username" 
          placeholder="请输入用户名" 
          required 
          minlength="3"
          maxlength="20"
        />
      </div>
      
      <div class="form-group">
        <label for="email">邮箱</label>
        <input 
          type="email" 
          id="email" 
          name="email" 
          placeholder="请输入邮箱地址" 
          required 
        />
      </div>
      
      <div class="form-group">
        <label for="password">密码</label>
        <input 
          type="password" 
          id="password" 
          name="password" 
          placeholder="至少6个字符" 
          required 
          minlength="6"
        />
      </div>
      
      <div class="form-group">
        <label for="confirmPassword">确认密码</label>
        <input 
          type="password" 
          id="confirmPassword" 
          name="confirmPassword" 
          placeholder="再次输入密码" 
          required 
        />
      </div>
      
      <button type="submit" class="btn-submit" id="submit-btn">注册</button>
    </form>
    
    <p class="switch-link">
      已有账号？<a href="/login">去登录</a>
    </p>
  </div>
</Layout>

<style>
  .form-container {
    background: white;
    padding: 2.5rem;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    width: 100%;
    max-width: 420px;
  }
  
  h2 {
    text-align: center;
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 1.8rem;
  }
  
  .form-group {
    margin-bottom: 1.2rem;
  }
  
  label {
    display: block;
    margin-bottom: 0.4rem;
    color: #555;
    font-weight: 500;
    font-size: 0.95rem;
  }
  
  input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e1e5ee;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
    outline: none;
  }
  
  input:focus {
    border-color: #667eea;
  }
  
  .btn-submit {
    width: 100%;
    padding: 0.85rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.3s, transform 0.2s;
    margin-top: 0.5rem;
  }
  
  .btn-submit:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }
  
  .btn-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .switch-link {
    text-align: center;
    margin-top: 1.5rem;
    color: #666;
  }
  
  .switch-link a {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
  }
  
  .message {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }
  
  .message.error {
    background: #fee;
    color: #c33;
    border: 1px solid #fcc;
  }
  
  .message.success {
    background: #efe;
    color: #363;
    border: 1px solid #cfc;
  }
</style>

<script>
  const form = document.getElementById('register-form') as HTMLFormElement;
  const messageDiv = document.getElementById('message') as HTMLElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // 禁用按钮，防止重复提交
    submitBtn.disabled = true;
    submitBtn.textContent = '注册中...';
    
    const formData = new FormData(form);
    
    try {
      const response = await fetch('/api/register', {
        method: 'POST',
        body: formData,
      });
      
      const data = await response.json();
      
      // 显示消息
      messageDiv.style.display = 'block';
      messageDiv.className = `message ${data.success ? 'success' : 'error'}`;
      messageDiv.textContent = data.message;
      
      if (data.success) {
        // 注册成功，2秒后跳转到控制台
        setTimeout(() => {
          window.location.href = '/dashboard';
        }, 1000);
      }
    } catch (error) {
      messageDiv.style.display = 'block';
      messageDiv.className = 'message error';
      messageDiv.textContent = '网络错误，请检查你的网络连接';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = '注册';
    }
  });
</script>